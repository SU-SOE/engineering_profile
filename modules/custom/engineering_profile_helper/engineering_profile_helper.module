<?php

/**
 * @file
 * Contains engineering_profile_helper.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Render\Markup;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_help().
 */
function engineering_profile_helper_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the engineering_profile_helper module.
    case 'help.page.engineering_profile_helper':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Engineering Profile Helper module') . '</p>';
      $output .= '<p>' . t('This module holds helper code specifically for the engineering_profile.') . '</p>';
      return $output;

    default:
  }
}

/**
 * @param $form
 * @param $form_state
 *
 */
function engineering_profile_form_views_exposed_form_alter(&$form, &$form_state){
  // Changes the label of the first item on dropdown for exposed filter on /spotlight
  if($form["#id"] == 'views-exposed-form-spotlights-block-1'){
    $form['tid']['#options']["All"] = t('All Departments');
    $form['tid_1']['#options']["All"] = t('All People');
  }
}

/**
 * Implements hook_preprocess_views_view_field().
 */
function engineering_profile_helper_preprocess_views_view_field(&$vars){
  if (isset($vars['view']) && ($vars['view']->id() == 'spotlights')) {
    if ($vars['field']->field == 'su_people_spotlight_quote') {
      // Modify the field for the regular view
      if ($vars['view']->current_display == 'block_1') {
        $new_output = _engineering_profile_helper_trim_spotlight_quote($vars['output']);
        $vars['output'] = Markup::create($new_output);
      }
      // Modify the field for the highlighted view at the top of the landing page
      if ($vars['view']->current_display == 'block_2') {
        $html = Html::load($vars['output']);
        $new_output = _engineering_profile_helper_trim_spotlight_quote($html->getElementsByTagName('div')->item(0)->nodeValue);
        $html->getElementsByTagName('div')->item(0)->nodeValue = $new_output;
        $vars['output'] = Markup::create($html->saveHTML($html->getElementsByTagName('div')->item(0)));
      }
    }
  }
}

/**
 * Trim down content for Spotlight quotes for use in Views.
 *
 * @param string $quote The full string value to truncate
 *
 */
function _engineering_profile_helper_trim_spotlight_quote(string $quote) {
  $string_array = explode("::", wordwrap(trim($quote), 100, "::"));
  $trimmed_punct = trim($string_array[0], '?!.');
  return $trimmed_punct . ' &hellip;';
}


/**
 * implements hook_update_n
 */
function engineering_profile_helper_update_8201(&$sandbox) {
  $modules = ['fontawesome'];
  \Drupal::database()->delete('key_value')
    ->condition('collection', 'system.schema')
    ->condition('name', $modules, 'IN')
    ->execute();
}
